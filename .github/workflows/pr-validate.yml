name: Validate Charts
on:
  pull_request:
    paths: ['charts/**']
jobs:
  ct:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Helm
        uses: azure/setup-helm@v4
        with: { version: v3.15.3 }
      - name: Run helm lint on changed charts
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t CHANGED < <(git diff --name-only origin/${{ github.base_ref }}... | grep '^charts/' || true)
          declare -A ROOTS=()
          for f in "${CHANGED[@]}"; do
            d="$f"
            while [[ "$d" != "." && -n "$d" ]]; do
              if [[ -f "$d/Chart.yaml" ]]; then ROOTS["$d"]=1; break; fi
              d=$(dirname "$d")
            done
          done
          for r in "${!ROOTS[@]}"; do
            echo "::group::helm lint $r"
            helm dependency update "$r" || true
            helm lint "$r"
            echo "::endgroup::"
          done
